#!/usr/bin/env bash
set -e

# Absolute path this script is in
SCRIPT_PATH="$( cd "$(dirname "$0")"/.. >/dev/null 2>&1 ; pwd -P )"
CMD=$1

if [ "$PWD" != "$SCRIPT_PATH" ]; then
    echo "Please run this command from the root of your job ($SCRIPT_PATH)"
    exit 1
fi

if ! command -v docker &> /dev/null; then
    echo "Please install docker"
    exit 1
fi

container_name=$(basename $SCRIPT_PATH)

if [ "$CMD" == "build" ]; then
  docker build . -t $container_name
  exit
fi

ADC_PATH="$HOME/.config/gcloud/application_default_credentials.json"

docker run\
  --mount type=bind,source=$ADC_PATH,target=/gcp/adc.json\
  --mount type=bind,source=$(pwd)/,target=/app/\
  --env GOOGLE_APPLICATION_CREDENTIALS=/gcp/adc.json\
  --env-file $SCRIPT_PATH/.env\
  $container_name "$@"
exit $?

